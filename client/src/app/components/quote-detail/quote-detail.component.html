<div class="container mt-4 quote-detail-content" *ngIf="!loading">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">询价单详情</h4>
      <button *ngIf="canEdit() && !editMode" class="btn btn-outline-primary btn-sm" (click)="toggleEditMode()" [disabled]="uploading">
        编辑
      </button>
    </div>
    
    <!-- 询价进度条 -->
    <div class="card-body bg-light py-3">
      <div class="progress-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted" style="font-weight: bold;font-size: large;">上传文件以推进报价进度</small>
          <small class="text-muted">{{ getProgressPercentage() }}%</small>
        </div>
        <div class="progress" style="height: 25px;">
          <div class="progress-bar" 
               [ngClass]="getProgressBarClass()" 
               role="progressbar" 
               [style.width.%]="getProgressPercentage()"
               [attr.aria-valuenow]="getProgressPercentage()" 
               aria-valuemin="0" 
               aria-valuemax="100">
            {{ getProgressText() }}
          </div>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <small [ngClass]="getStepClass('pending')" class="progress-step">待处理</small>
          <small [ngClass]="getStepClass('in_progress')" class="progress-step">处理中</small>
          <small [ngClass]="getStepClass('supplier_quoted')" class="progress-step">核价中</small>
          <small [ngClass]="getStepClass('rejected')" class="progress-step">不报价</small>
          <small [ngClass]="getStepClass('quoted')" class="progress-step">最终报价完成</small>
        </div>
      </div>
    </div>
    
    <div class="card-body">
      <!-- 错误信息 -->
      <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
      
      <!-- 询价单详情 -->
      <div *ngIf="quote" class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label fw-bold">询价号:</label>
            <div class="form-control-plaintext text-primary fw-bold">{{ quote.quoteNumber }}</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">标题:</label>
            <div *ngIf="!editMode" class="form-control-plaintext">{{ quote.title }}</div>
            <input *ngIf="editMode" type="text" class="form-control" [(ngModel)]="quoteForm.title">
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">描述:</label>
            <div *ngIf="!editMode" class="form-control-plaintext">{{ quote.description }}</div>
            <textarea *ngIf="editMode" class="form-control" rows="3" [(ngModel)]="quoteForm.description"></textarea>
          </div>
          
          <div class="mb-3" *ngIf="quote.rejectReason">
            <label class="form-label fw-bold">不予报价理由:</label>
            <div class="alert alert-warning">{{ quote.rejectReason }}</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">状态:</label>
            <span class="badge" [ngClass]="{
              'bg-secondary': quote.status === 'pending',
              'bg-info': quote.status === 'supplier_quoted',
              'bg-warning': quote.status === 'in_progress',
              'bg-success': quote.status === 'quoted',
              'bg-danger': quote.status === 'cancelled',
              'bg-dark': quote.status === 'rejected'
            }">
              {{ getStatusDisplayName(quote.status) }}
            </span>
          </div>
          
          <div class="mb-3" *ngIf="authService.hasRole('customer')">
            <div class="form-check">
              <input type="checkbox" 
                     class="form-check-input" 
                     id="urgentCheck"
                     [(ngModel)]="quote.urgent"
                     [disabled]="quote.status === 'quoted'"
                     (change)="updateUrgentStatus()">
              <label class="form-check-label fw-bold" for="urgentCheck">
                加急
              </label>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label fw-bold">客户:</label>
            <div class="form-control-plaintext">{{ quote.customer.name }} ({{ quote.customer.email }})</div>
          </div>
          
          <div class="mb-3" *ngIf="quote.quoter">
            <label class="form-label fw-bold">报价员:</label>
            <div class="form-control-plaintext">{{ quote.quoter.name }} ({{ quote.quoter.email }})</div>
          </div>
          
          <!-- 个人供应商分配已禁用，请使用群组分配 -->

          <!-- 群组分配显示 -->
          <div class="mb-3" *ngIf="quote && !authService.hasRole('customer')">
            <label class="form-label fw-bold">分配群组:</label>
            <div *ngIf="quote.assignedGroups && quote.assignedGroups.length > 0" class="d-flex flex-wrap gap-2">
              <span *ngFor="let group of quote.assignedGroups" 
                    class="badge" 
                    [style.backgroundColor]="group.color + '20'"
                    [style.borderColor]="group.color"
                    [style.color]="group.color"
                    style="border: 1px solid; padding: 6px 12px;">
                <i class="bi bi-tags-fill me-1"></i>{{ group.name }}
                <button *ngIf="canAssignGroups()" 
                        class="btn btn-sm p-0 ms-1 text-danger" 
                        (click)="removeGroupAssignment(group._id)" 
                        [disabled]="assigning" 
                        title="移除群组分配">
                  <i class="bi bi-x-circle-fill" style="font-size: 1em;"></i>
                </button>
              </span>
            </div>
            <div *ngIf="!quote.assignedGroups || quote.assignedGroups.length === 0" class="form-control-plaintext text-muted">
              未分配群组
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">创建时间:</label>
            <div class="form-control-plaintext">{{ quote.createdAt | date:'yyyy-MM-dd HH:mm' }}</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">更新时间:</label>
            <div class="form-control-plaintext">{{ quote.updatedAt | date:'yyyy-MM-dd HH:mm' }}</div>
          </div>
        </div>
      </div>

      <!-- 分配群组（下拉菜单样式） -->
      <div *ngIf="quote && authService.hasRole('quoter') && (quote.status === 'pending' || quote.status === 'in_progress')" class="mt-4">
        <h5>分配供应商群组</h5>
        <div class="mb-3">
          <div class="input-group">
            <select class="form-select" [(ngModel)]="selectedGroupId">
              <option value="">请选择群组</option>
              <option *ngFor="let group of groups" [value]="group._id">
                {{ group.name }} ({{ group.users ? group.users.length : 0 }}个供应商成员)
              </option>
            </select>
            <button class="btn btn-primary" (click)="assignSingleGroup()" [disabled]="!selectedGroupId || assigning">
              {{ assigning ? '分配中...' : '分配' }}
            </button>
          </div>
        </div>
      </div>
      
      <!-- 文件操作 -->
      <div *ngIf="quote" class="mt-4">
        <h5>文件操作</h5>
        
        <!-- 客户询价文件 -->
        <div *ngIf="hasFiles('customer')" class="mb-3 file-operation">
          <div class="alert" [ngClass]="getTempFilesByType('customer').length > 0 ? 'alert-warning' : 'alert-primary'">
            <div class="d-flex justify-content-between align-items-center">
              <strong>客户询价文件:</strong>
            </div>
            <div *ngIf="getTempFilesByType('customer').length > 0" class="alert alert-warning small mt-2 mb-2">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              有 {{ getTempFilesByType('customer').length }} 个文件待上传，请点击"确认更新"按钮完成上传
            </div>
            <div *ngFor="let file of getFiles('customer'); let i = index" class="file-link-container">
              <span *ngIf="file.isTemp" class="badge bg-warning me-2">待上传</span>
              <a href="javascript:void(0)" class="file-link" 
                 [ngClass]="file.isTemp ? 'text-warning' : 'text-primary'" 
                 (click)="downloadFile('customer', i)" 
                 [class.disabled]="uploading || file.isTemp"
                 title="{{ file.originalName + (file.isTemp ? ' (待上传)' : '') }}">
                {{ file.originalName }}
              </a>
              <button *ngIf="file.isTemp" class="btn btn-outline-warning btn-sm ms-2" (click)="removeFile('customer', i)" [disabled]="uploading" title="删除待上传文件">
                删除
              </button>
              <button *ngIf="!file.isTemp && canDeleteFile('customer')" class="btn btn-outline-danger btn-sm ms-2" (click)="removeFile('customer', i)" [disabled]="uploading" title="删除文件">
                撤回
              </button>
            </div>
            <div class="mt-2">
              <button *ngIf="getTempFilesByType('customer').length > 0" 
                      class="btn btn-success btn-sm me-2" 
                      (click)="confirmUpdateFiles('customer')" 
                      [disabled]="uploading">
                <i class="bi bi-upload me-1"></i>确认更新 ({{ getTempFilesByType('customer').length }})
              </button>
              <button *ngIf="getFiles('customer').length > 1 && getTempFilesByType('customer').length === 0" 
                      class="btn btn-outline-primary btn-sm" 
                      (click)="downloadFilesBatch('customer')" 
                      [disabled]="uploading" 
                      title="一键下载所有询价文件">
                一键下载
              </button>
            </div>
          </div>
        </div>
        
        <!-- 供应商报价文件 -->
        <div *ngIf="hasFiles('supplier')" class="mb-3 file-operation">
          <div class="alert" [ngClass]="getTempFilesByType('supplier').length > 0 ? 'alert-warning' : 'alert-info'">
            <div class="d-flex justify-content-between align-items-center">
              <strong>供应商报价文件:</strong>
            </div>
            <div *ngIf="getTempFilesByType('supplier').length > 0" class="alert alert-warning small mt-2 mb-2">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              有 {{ getTempFilesByType('supplier').length }} 个文件待上传，请点击"确认更新"按钮完成上传
            </div>
            <div *ngFor="let file of getFiles('supplier'); let i = index" class="file-link-container">
              <span *ngIf="file.isTemp" class="badge bg-warning me-2">待上传</span>
              <a href="javascript:void(0)" class="file-link" 
                 [ngClass]="file.isTemp ? 'text-warning' : 'text-info'" 
                 (click)="downloadFile('supplier', i)" 
                 [class.disabled]="uploading || file.isTemp"
                 title="{{ file.originalName + (file.isTemp ? ' (待上传)' : '') }}">
                {{ file.originalName }}
              </a>
              <button *ngIf="file.isTemp" class="btn btn-outline-warning btn-sm ms-2" (click)="removeFile('supplier', i)" [disabled]="uploading" title="删除待上传文件">
                删除
              </button>
              <button *ngIf="!file.isTemp && canDeleteFile('supplier')" class="btn btn-outline-danger btn-sm ms-2" (click)="removeFile('supplier', i)" [disabled]="uploading" title="删除文件">
                撤回
              </button>
            </div>
            <div class="mt-2">
              <button *ngIf="quote.status === 'in_progress' && authService.hasRole('supplier')" 
                      class="btn btn-success btn-sm me-2" 
                      (click)="confirmSupplierQuote()" 
                      [disabled]="uploading" 
                      title="确认报价">
                确认报价
              </button>
              <button *ngIf="quote.status === 'supplier_quoted' && getTempFilesByType('supplier').length > 0" 
                      class="btn btn-success btn-sm me-2" 
                      (click)="confirmUpdateFiles('supplier')" 
                      [disabled]="uploading">
                <i class="bi bi-upload me-1"></i>确认更新 ({{ getTempFilesByType('supplier').length }})
              </button>
              <button *ngIf="getFiles('supplier').length > 1 && getTempFilesByType('supplier').length === 0" 
                      class="btn btn-outline-info btn-sm" 
                      (click)="downloadFilesBatch('supplier')" 
                      [disabled]="uploading" 
                      title="一键下载所有报价文件">
                一键下载
              </button>
            </div>
          </div>
        </div>
        
        <!-- 最终报价文件 -->
        <div *ngIf="hasFiles('quoter')" class="mb-3 file-operation">
          <div class="alert" [ngClass]="getTempFilesByType('quoter').length > 0 ? 'alert-warning' : 'alert-success'">
            <div class="d-flex justify-content-between align-items-center">
              <strong>最终报价文件:</strong>
            </div>
            <div *ngIf="getTempFilesByType('quoter').length > 0" class="alert alert-warning small mt-2 mb-2">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              有 {{ getTempFilesByType('quoter').length }} 个文件待上传，请点击"确认更新"按钮完成上传
            </div>
            <div *ngFor="let file of getFiles('quoter'); let i = index" class="file-link-container">
              <span *ngIf="file.isTemp" class="badge bg-warning me-2">待上传</span>
              <a href="javascript:void(0)" class="file-link" 
                 [ngClass]="file.isTemp ? 'text-warning' : 'text-success'" 
                 (click)="downloadFile('quoter', i)" 
                 [class.disabled]="uploading || file.isTemp"
                 title="{{ file.originalName + (file.isTemp ? ' (待上传)' : '') }}">
                {{ file.originalName }}
              </a>
              <button *ngIf="file.isTemp" class="btn btn-outline-warning btn-sm ms-2" (click)="removeFile('quoter', i)" [disabled]="uploading" title="删除待上传文件">
                删除
              </button>
              <button *ngIf="!file.isTemp && canDeleteFile('quoter')" class="btn btn-outline-danger btn-sm ms-2" (click)="removeFile('quoter', i)" [disabled]="uploading" title="删除文件">
                撤回
              </button>
            </div>
            <div class="mt-2">
              <button *ngIf="quote.status !== 'quoted' && authService.hasRole('quoter')" 
                      class="btn btn-primary btn-sm me-2" 
                      (click)="confirmFinalQuote()" 
                      [disabled]="uploading" 
                      title="确认最终报价">
                确认最终报价
              </button>
              <button *ngIf="getTempFilesByType('quoter').length > 0 && quote.status === 'quoted'"
                      class="btn btn-success btn-sm me-2" 
                      (click)="confirmUpdateFiles('quoter')" 
                      [disabled]="uploading">
                <i class="bi bi-upload me-1"></i>确认更新 ({{ getTempFilesByType('quoter').length }})
              </button>
              <button *ngIf="getFiles('quoter').length > 1 && getTempFilesByType('quoter').length === 0" 
                      class="btn btn-outline-success btn-sm" 
                      (click)="downloadFilesBatch('quoter')" 
                      [disabled]="uploading" 
                      title="一键下载所有最终报价文件">
                一键下载
              </button>
            </div>
          </div>
        </div>
        
        <!-- 文件上传区域 -->
        <div class="mt-4" *ngIf="canShowUploadButton()">
          <h5>上传文件</h5>
          
          <!-- 上传中状态 -->
          <div *ngIf="uploading" class="upload-status text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">上传中...</span>
            </div>
            <div class="upload-text">
              正在上传文件，请稍候...
            </div>
          </div>
          
          <!-- 上传文件按钮 -->
          <div *ngIf="!uploading" class="btn-group">
            <label class="btn btn-outline-success">
              选择文件
              <input type="file" accept=".xlsx,.xls" multiple (change)="onFilesSelected($event)" [disabled]="uploading" style="display: none;">
            </label>
            <button *ngIf="canReject()" class="btn btn-outline-danger" (click)="rejectQuote()" [disabled]="uploading">
              不予报价
            </button>
          </div>
          
          <!-- 提示信息 -->
          <div *ngIf="!uploading" class="text-muted small mt-2">
            支持选择多个Excel文件，选择后会直接显示在文件列表中，请点击"确认更新"按钮完成上传
          </div>
        </div>
      </div>
      
      <!-- 编辑模式按钮 -->
      <div *ngIf="editMode" class="mt-4">
        <button class="btn btn-success me-2" (click)="saveChanges()" [disabled]="uploading">保存</button>
        <button class="btn btn-secondary" (click)="toggleEditMode()" [disabled]="uploading">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- 群组分配模态框 -->
<div *ngIf="showGroupAssignModal" class="modal-overlay" (click)="closeGroupAssignModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5>分配群组 - {{ quote?.title }}</h5>
      <button class="btn-close" (click)="closeGroupAssignModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="mb-3">
        <label class="form-label">选择要分配的群组:</label>
        <div class="groups-list">
          <div class="form-check mb-2" *ngFor="let group of groups">
            <input class="form-check-input" type="checkbox" 
                   [id]="'group-' + group._id"
                   [value]="group._id"
                   [checked]="selectedGroupIds.includes(group._id)"
                   (change)="onGroupSelectionChange(group._id, $event)">
            <label class="form-check-label" [for]="'group-' + group._id">
              <span class="badge me-2" 
                    [style.backgroundColor]="group.color + '20'"
                    [style.borderColor]="group.color"
                    [style.color]="group.color"
                    style="border: 1px solid;">
                <i class="bi bi-tags-fill"></i>
              </span>
              <strong>{{ group.name }}</strong>
              <div class="text-muted small" *ngIf="group.description">{{ group.description }}</div>
              <div class="text-muted small" *ngIf="group.users && group.users.length > 0">
                <i class="bi bi-people-fill"></i> {{ group.users.length }} 个供应商成员
              </div>
            </label>
          </div>
        </div>
      </div>
      
      <div class="selected-info" *ngIf="selectedGroupIds.length > 0">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          已选择 {{ selectedGroupIds.length }} 个群组，分配后询价单状态将变为"处理中"并向所有群组成员发送邮件通知。
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeGroupAssignModal()">取消</button>
      <button type="button" class="btn btn-primary" 
              (click)="assignGroupsToQuote()" 
              [disabled]="selectedGroupIds.length === 0 || assigning">
        {{ assigning ? '分配中...' : '确认分配' }}
      </button>
    </div>
  </div>
</div>

<!-- 加载中状态 -->
<div *ngIf="loading" class="container mt-4">
  <div class="d-flex justify-content-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">加载中...</span>
    </div>
  </div>
</div>