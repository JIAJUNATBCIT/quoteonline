# 供应商重新分配功能

## 功能描述

实现了报价员删除已分配供应商并重新分配的功能。当报价员分配供应商后，可以在询价单详情页面看到已分配的供应商信息，并且可以通过以下方式进行管理：

1. **删除已分配的供应商**：点击供应商旁边的红叉按钮（×）或"移除供应商"按钮
2. **重新分配供应商**：删除供应商后，供应商选择列表会重新出现，允许重新分配
3. **直接重新分配**：也可以直接选择新供应商来替换当前分配

## 实现细节

### 后端 API

#### 新增端点
- `PATCH /api/quotes/:id/remove-supplier` - 移除供应商分配

**权限要求**：只有报价员和管理员可以调用此API

**业务逻辑**：
- 检查询价单是否存在
- 验证是否有供应商分配
- 检查询价单状态（只能在 `pending` 或 `in_progress` 状态下移除）
- 移除供应商分配并将状态重置为 `pending`

### 前端实现

#### 新增服务方法
在 `QuoteService` 中添加了 `removeSupplierAssignment()` 方法

#### 组件更新
在 `QuoteDetailComponent` 中：
- 添加了 `removeSupplierAssignment()` 方法处理删除逻辑
- 添加了确认对话框防止误操作
- 更新了模板显示逻辑

#### UI 改进

**供应商显示区域**：
- 在询价单基本信息区域显示当前分配的供应商信息
- 在供应商信息旁边添加醒目的圆形红色叉按钮（×）用于删除当前分配
- 按钮具有悬停效果和动画，提升用户体验
- 界面简洁，避免重复显示

**分配区域**：
- 当没有供应商时显示分配界面
- 删除供应商后，分配区域自动重新出现
- 状态：`pending` 或 `in_progress` 且无供应商时显示

**状态管理**：
- 只有在 `pending` 或 `in_progress` 状态下才允许重新分配
- 移除供应商后状态自动重置为 `pending`

## 使用流程

1. **报价员登录**并进入询价单详情页面
2. **查看已分配供应商**：在询价单基本信息区域看到当前分配的供应商
3. **删除供应商**：点击供应商信息旁边的红色叉按钮（×）
4. **确认删除**：系统弹出确认对话框
5. **重新分配**：删除后，下方的"分配供应商"区域自动重新出现，可以选择新供应商
6. **完成操作**：系统自动更新询价单状态和供应商信息

## 权限控制

- **报价员**：可以对自己负责的询价单进行供应商重新分配
- **管理员**：可以对所有询价单进行供应商重新分配
- **其他角色**：无权访问此功能

## 状态流转

```
pending (无供应商) → in_progress (有供应商) → pending (移除供应商)
                                    ↓
                              supplier_quoted (供应商确认报价)
```

## 测试建议

1. 测试在不同状态下移除供应商的权限控制
2. 测试移除供应商后状态是否正确重置
3. 测试重新分配后邮件通知是否正常发送
4. 测试并发操作时的数据一致性
5. 测试前端UI的响应和状态更新

## 注意事项

- 只有在 `pending` 或 `in_progress` 状态下才能移除供应商
- 移除供应商后，询价单状态会重置为 `pending`
- 如果供应商已经确认报价（`supplier_quoted` 状态），则无法移除
- 所有操作都会记录在系统日志中便于追踪